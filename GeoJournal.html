<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoJournal v12.4 | UI Final</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --sidebar: 320px; --primary: #2563eb; --accent: #10b981;
            --bg: #f8fafc; --card: #ffffff; --text: #0f172a; --border: #e2e8f0;
        }
        .dark-theme { --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --border: #334155; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Inter', sans-serif; overflow: hidden; background: var(--bg); color: var(--text); }
        #app { display: flex; height: 100vh; }
        
        #sidebar { 
            width: var(--sidebar); background: var(--card); border-right: 1px solid var(--border); 
            display: flex; flex-direction: column; z-index: 2000; height: 100vh; box-sizing: border-box; 
        }

        .sidebar-header { padding: 20px 20px 0 20px; flex-shrink: 0; }
        .logo-row { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        #backBtn { 
            display: none; background: var(--border); border: none; padding: 5px 10px; 
            border-radius: 6px; cursor: pointer; font-weight: 800; font-size: 10px; color: var(--text);
        }
        
        .tab-nav { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: rgba(0,0,0,0.03); border-radius: 8px; font-weight: 700; cursor: pointer; color: var(--text); opacity: 0.5; transition: 0.2s; font-size: 12px; }
        .tab-btn.active { opacity: 1; background: var(--primary); color: white; }

        .sidebar-scroll-area { flex: 1; overflow-y: auto; padding: 0 20px; margin: 15px 0; display: flex; flex-direction: column; }
        .sidebar-scroll-area::-webkit-scrollbar { width: 4px; }
        .sidebar-scroll-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

        .sidebar-footer { padding: 0 20px 20px 20px; flex-shrink: 0; position: relative; }
        #map { flex-grow: 1; z-index: 1; position: relative; }

        /* SETTINGS POP-OUT */
        #settingsMenu { 
            display: none; position: absolute; bottom: 70px; left: 20px; right: 20px; 
            background: var(--card); border: 1px solid var(--border); border-radius: 12px; 
            padding: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 3000;
        }
        .settings-row { display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-bottom: 10px; }
        .settings-row:last-child { margin-bottom: 0; }
        .toggle-box { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 8px; border: 1px solid var(--border); border-radius: 10px; background: rgba(0,0,0,0.01); }

        .switch { position: relative; display: inline-block; width: 40px; height: 20px; margin-top: 5px;}
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: #cbd5e1; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); }

        .filter-container { margin-bottom: 15px; display: flex; flex-direction: column; gap: 6px; }
        .filter-row { display: flex; gap: 6px; }
        .filter-btn { flex: 1; border: none; background: #64748b; padding: 8px; font-size: 10px; font-weight: 700; cursor: pointer; border-radius: 8px; color: white; transition: 0.2s; opacity: 0.6; }
        .filter-btn.active { background: var(--primary); opacity: 1; }

        .gps-indicator-wrapper { position: relative; width: 14px; height: 14px; display: flex; align-items: center; justify-content: center; }
        .gps-indicator { width: 14px !important; height: 14px !important; background: #2563eb; border: 2px solid white; border-radius: 50% !important; z-index: 2; flex-shrink: 0; aspect-ratio: 1/1; }
        .gps-pulse { position: absolute; width: 32px !important; height: 32px !important; background: rgba(37, 99, 235, 0.4); border-radius: 50% !important; animation: pulse 2s infinite; z-index: 1; flex-shrink: 0; aspect-ratio: 1/1; }
        @keyframes pulse { 0% { transform: scale(0.5); opacity: 1; } 100% { transform: scale(2.5); opacity: 0; } }

        .highlight-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(0,0,0,0.03); border-radius: 10px; margin-bottom: 8px; cursor: pointer; border: 1px solid transparent; }
        .highlight-thumb { width: 48px; height: 48px; border-radius: 8px; object-fit: cover; background: #ddd; flex-shrink: 0; }
        .type-label { font-size: 9px; font-weight: 800; text-transform: uppercase; padding: 2px 5px; background: var(--primary); color: white; border-radius: 3px; display: inline-block; margin-bottom: 3px; }

        #detail-view { display: none; flex-direction: column; gap: 8px; }
        .edit-input { width: 100%; background: transparent; border: 1px solid transparent; border-radius: 6px; padding: 2px 5px; color: var(--text); font-family: inherit; box-sizing: border-box; pointer-events: none;}
        .edit-input.active { border: 1px solid var(--border); background: var(--bg); pointer-events: auto; }
        #editTitle { font-size: 1.6rem; font-weight: 900; white-space: normal; overflow-wrap: break-word; line-height: 1.1; margin-bottom: 0; }
        .rating-stars { color: #fbbf24; font-size: 1.8rem; display: flex; gap: 6px; margin-top: -2px; }
        #editDesc { font-size: 1.1rem; line-height: 1.5; opacity: 0.9; }
        .info-card { background: rgba(0,0,0,0.02); padding: 10px; border-radius: 10px; border: 1px solid var(--border); }
        .stat-line { font-size: 11px; font-weight: bold; opacity: 0.7; padding: 2px 5px; line-height: 1.4; }

        .zoom-controls { position: absolute; bottom: 30px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 8px; }
        .zoom-btn { width: 45px; height: 45px; background: var(--card); border: 1px solid var(--border); border-radius: 10px; font-size: 22px; cursor: pointer; color: var(--text); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .btn { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; margin-bottom: 10px; transition: 0.2s; }
        .btn-main { background: #64748b; color: white; }
        .btn-main.active-mode { background: var(--primary); }
        
        .btn-actions { display: flex; gap: 8px; align-items: center; margin-top: 10px; }
        .btn-edit { background: var(--primary); color: white; padding: 10px 20px; font-size: 13px; font-weight: 700; border-radius: 8px; width: auto; border: none; cursor: pointer; }
        .btn-edit.active-saving { background: var(--accent); }
        .btn-delete { color: red; border: 1px solid red; background: none; padding: 10px 15px; border-radius: 8px; font-size: 11px; font-weight: bold; cursor: pointer; }
        
        .btn-upload { background: var(--border); color: var(--text); padding: 8px 12px; font-size: 11px; border-radius: 6px; cursor: pointer; display: inline-block; font-weight: bold; }
        #elevation-dock { position: absolute; bottom: -280px; left: 20px; right: 20px; height: 260px; background: var(--card); border-radius: 12px 12px 0 0; border: 1px solid var(--border); z-index: 1500; padding: 15px; transition: 0.4s ease; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); }
        #elevation-dock.active { bottom: 0; }
        #modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 4000; }
        .modal { background: var(--card); padding: 20px; border-radius: 15px; width: 320px; display: flex; flex-direction: column; gap: 0px; }
    </style>
</head>
<body class="light-theme">

    <div id="app">
        <aside id="sidebar">
            <div class="sidebar-header">
                <div class="logo-row">
                    <button id="backBtn" onclick="goBack()">‚Üê BACK</button>
                    <h2 style="margin: 0;">GeoJournal</h2>
                </div>
                <input type="text" id="mainSearch" style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--border); background:var(--bg); color:var(--text); box-sizing:border-box; margin-bottom:15px;" placeholder="üîç Search City...">
                
                <div class="tab-nav" id="mainTabs">
                    <button class="tab-btn active" id="exploreTab" onclick="switchTab('explore')">EXPLORE</button>
                    <button class="tab-btn" id="addTab" onclick="switchTab('add')">ADD</button>
                </div>
            </div>

            <div class="sidebar-scroll-area">
                <div id="explore-panel">
                    <div class="filter-container">
                        <div class="filter-row">
                            <button class="filter-btn active" onclick="setFilter('type', 'all', this)">ALL</button>
                            <button class="filter-btn" onclick="setFilter('type', 'PIN', this)">PINS</button>
                            <button class="filter-btn" onclick="setFilter('type', 'WALK', this)">WALKS</button>
                        </div>
                        <div class="filter-row">
                            <button class="filter-btn active" onclick="setFilter('sort', 'rating', this)">‚≠ê RATING</button>
                            <button class="filter-btn" onclick="setFilter('sort', 'dist', this)">üìç DISTANCE</button>
                        </div>
                    </div>
                    <h4 style="margin: 0 0 10px 0; opacity: 0.6;">Nearby Highlights</h4>
                    <div id="highlights-list"></div>
                </div>

                <div id="add-panel" style="display:none;">
                    <button id="pinModeBtn" class="btn btn-main">üìç Drop a Pin</button>
                    <button id="walkModeBtn" class="btn btn-main">üèÉ Draw a Walk</button>
                    <div id="route-stats" style="display:none; background:rgba(0,0,0,0.05); padding:10px; border-radius:8px;">
                        <p id="liveDist" style="margin:0; font-weight:bold; font-size: 1.1rem;">0.00 km</p>
                        <button class="btn" id="finishWalkBtn" style="margin-top:10px; background:var(--accent); color:white; margin-bottom: 0;">Finish & Save Walk</button>
                    </div>
                </div>

                <div id="detail-view">
                    <img id="detPhoto" style="width:100%; height:160px; object-fit:cover; border-radius:12px; display:none; margin-bottom:10px;">
                    <div id="uploadContainer" style="display:none; margin-bottom:10px;">
                        <label class="btn-upload" for="photoInput">üì∑ UPLOAD PHOTO</label>
                        <input type="file" id="photoInput" accept="image/*" style="display:none;">
                    </div>
                    <textarea id="editTitle" class="edit-input" rows="2" style="font-weight:900;"></textarea>
                    <div id="detRating" class="rating-stars"></div>
                    <div class="info-card"><textarea id="editDesc" class="edit-input" rows="4" placeholder="No notes added..."></textarea></div>
                    <div id="detStats" class="stat-line"></div>
                    <div class="btn-actions">
                        <button class="btn-edit" id="toggleEditBtn">‚úèÔ∏è EDIT ENTRY</button>
                        <button class="btn-delete" id="deleteItemBtn" style="display:none;">DELETE</button>
                    </div>
                </div>
            </div>

            <div class="sidebar-footer">
                <div id="settingsMenu">
                    <div class="settings-row">
                        <div class="toggle-box"><span>Dark Mode</span><label class="switch"><input type="checkbox" id="themeToggle"><span class="slider"></span></label></div>
                        <div class="toggle-box"><span>Satalite</span><label class="switch"><input type="checkbox" id="mapToggle"><span class="slider"></span></label></div>
                    </div>
                </div>
                <button class="btn btn-main" style="margin-bottom:0;" onclick="toggleSettings()">‚öôÔ∏è SETTINGS</button>
            </div>
        </aside>

        <div id="map">
            <div class="zoom-controls"><button class="zoom-btn" id="locateBtn">üéØ</button><button class="zoom-btn" onclick="map.zoomIn()">+</button><button class="zoom-btn" onclick="map.zoomOut()">‚àí</button></div>
            <div id="elevation-dock">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;"><strong>Elevation Profile</strong><button onclick="closeElevation()" style="border:none; background:none; cursor:pointer; font-size:20px;">‚úï</button></div>
                <div style="height:170px;"><canvas id="elevChart"></canvas></div>
            </div>
        </div>
    </div>

    <div id="modal-overlay"><div class="modal"><h3>Save Entry</h3><div id="modalStars" style="font-size: 2.5rem; color: #cbd5e1; cursor: pointer; display: flex; gap: 8px; margin-bottom: 10px;"><span class="star" data-value="1">‚òÖ</span><span class="star" data-value="2">‚òÖ</span><span class="star" data-value="3">‚òÖ</span><span class="star" data-value="4">‚òÖ</span><span class="star" data-value="5">‚òÖ</span></div><input type="text" id="itemName" placeholder="Location Name" style="width:100%; padding:10px; margin-bottom:10px; border:1px solid var(--border); border-radius:8px;"><textarea id="itemDesc" placeholder="Notes..." style="width:100%; padding:10px; margin-bottom:15px; border:1px solid var(--border); border-radius:8px; height: 80px;"></textarea><button class="btn" style="background:var(--accent); color:white; margin-bottom: 8px;" id="confirmSaveBtn">Save to Library</button><button class="btn" style="background:none; border:1px solid var(--border); margin-bottom: 0;" onclick="document.getElementById('modal-overlay').style.display='none'">Cancel</button></div></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        let storage = JSON.parse(localStorage.getItem('geojournal_v11')) || { pins: [], walks: [], theme: 'light', mapStyle: 'voyager' };
        let currentMode = 'explore', tempPath = [], pendingCoords = null, activeSelectionId = null, currentRating = 0, isEditing = false;
        let activeFilters = { type: 'all', sort: 'rating' };
        let mapItems = new L.FeatureGroup(), userPos = null, userMarker = null, nodeHandles = [], chartInstance = null;
        
        const map = L.map('map', { zoomControl: false }).setView([51.505, -0.09], 13);
        mapItems.addTo(map);
        const mapStyles = { voyager: 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', sat: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}' };
        let baseLayer = L.tileLayer(mapStyles[storage.mapStyle]).addTo(map);
        let tempPoly = L.polyline([], {color: '#10b981', weight: 4, dashArray: '5, 10'}).addTo(map);

        document.body.className = storage.theme + '-theme';
        document.getElementById('themeToggle').checked = (storage.theme === 'dark');
        document.getElementById('mapToggle').checked = (storage.mapStyle === 'sat');

        map.on('locationfound', (e) => {
            userPos = e.latlng;
            if (!userMarker) userMarker = L.marker(e.latlng, { icon: L.divIcon({ className: '', html: '<div class="gps-indicator-wrapper"><div class="gps-indicator"></div><div class="gps-pulse"></div></div>', iconSize: [14, 14], iconAnchor: [7, 7] }) }).addTo(map);
            else userMarker.setLatLng(e.latlng);
            updateHighlights();
        });
        map.locate({ setView: true, maxZoom: 15, watch: true });

        function toggleSettings() {
            const menu = document.getElementById('settingsMenu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }

        function goBack() {
            document.getElementById('backBtn').style.display = 'none';
            document.getElementById('mainTabs').style.display = 'flex';
            document.getElementById('detail-view').style.display = 'none';
            switchTab('explore');
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tab + 'Tab').classList.add('active');
            document.getElementById('explore-panel').style.display = (tab === 'explore' ? 'block' : 'none');
            document.getElementById('add-panel').style.display = (tab === 'add' ? 'block' : 'none');
            document.getElementById('detail-view').style.display = 'none';
            setMode(tab === 'explore' ? 'explore' : 'ready');
        }

        function setFilter(category, value, btn) {
            activeFilters[category] = value;
            btn.parentElement.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updateHighlights();
        }

        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.btn-main').forEach(b => b.classList.remove('active-mode'));
            if (document.getElementById(mode + 'ModeBtn')) document.getElementById(mode + 'ModeBtn').classList.add('active-mode');
            document.getElementById('route-stats').style.display = (mode === 'walk' ? 'block' : 'none');
            isEditing = false; nodeHandles.forEach(h => map.removeLayer(h)); closeElevation();
            if(mode !== 'walk' && mode !== 'pin') { tempPath = []; tempPoly.setLatLngs([]); }
        }

        document.getElementById('pinModeBtn').onclick = () => setMode('pin');
        document.getElementById('walkModeBtn').onclick = () => setMode('walk');

        function updateHighlights() {
            const list = document.getElementById('highlights-list');
            if (document.getElementById('explore-panel').style.display === 'none' || document.getElementById('detail-view').style.display === 'flex') return;
            let all = [...storage.pins.map(p => ({...p, type:'PIN'})), ...storage.walks.map(w => ({...w, type:'WALK', lat:w.path[0][0], lng:w.path[0][1]}))];
            if (activeFilters.type !== 'all') all = all.filter(i => i.type === activeFilters.type);
            if (userPos) all.forEach(i => i.d = L.latLng(i.lat, i.lng).distanceTo(userPos) / 1000);
            if (activeFilters.sort === 'rating') all.sort((a,b) => b.rating - a.rating);
            else all.sort((a,b) => (a.d || 0) - (b.d || 0));
            list.innerHTML = all.length ? '' : '<p style="font-size:12px;opacity:0.5;text-align:center;">Empty library.</p>';
            all.forEach(i => {
                const div = document.createElement('div'); div.className = 'highlight-item';
                div.innerHTML = `<img class="highlight-thumb" src="${i.photo || 'https://placehold.co/100?text=No+Photo'}">
                    <div style="flex:1"><span class="type-label">${i.type}</span><p style="font-weight:bold;font-size:13px;margin:0;">${i.name}</p><div style="font-size:11px;color:#fbbf24;">${'‚òÖ'.repeat(i.rating)} <span style="color:var(--text);opacity:0.5;">${i.d?i.d.toFixed(1)+'km away':''}</span></div></div>`;
                div.onclick = () => {
                    const obj = i.type === 'PIN' ? storage.pins.find(p=>p.id===i.id) : storage.walks.find(w=>w.id===i.id);
                    map.flyTo([i.lat, i.lng], 15);
                    const layer = mapItems.getLayers().find(l => (i.type === 'WALK' && l instanceof L.Polyline && JSON.stringify(l.getLatLngs()[0]) === JSON.stringify(L.latLng(i.lat, i.lng))) || (i.type === 'PIN' && l instanceof L.Marker && l.getLatLng().equals(L.latLng(i.lat, i.lng))));
                    showDetails(obj, i.type==='WALK', layer);
                };
                list.appendChild(div);
            });
        }

        map.on('click', (e) => {
            if (isEditing && window.currentActiveLayer instanceof L.Polyline) {
                const lls = window.currentActiveLayer.getLatLngs(); lls.push(e.latlng);
                window.currentActiveLayer.setLatLngs(lls); updateWalkStats(); createNodes(window.currentActiveLayer); return;
            }
            if (currentMode === 'pin') { pendingCoords = e.latlng; currentRating = 0; document.getElementById('modal-overlay').style.display = 'flex'; }
            if (currentMode === 'walk') { tempPath.push([e.latlng.lat, e.latlng.lng]); tempPoly.setLatLngs(tempPath); let d = 0; for(let i=1; i<tempPath.length; i++) d += L.latLng(tempPath[i-1]).distanceTo(L.latLng(tempPath[i])); document.getElementById('liveDist').innerText = `${(d/1000).toFixed(2)} km`; fetchElevation(tempPath); }
        });

        document.getElementById('confirmSaveBtn').onclick = async () => {
            const id = Date.now(), name = document.getElementById('itemName').value || "Untitled", desc = document.getElementById('itemDesc').value || "", rat = currentRating;
            let flat, flon;
            if (currentMode === 'pin') {
                flat = pendingCoords.lat; flon = pendingCoords.lng;
                const p = { id, name, desc, rating: rat, lat: flat, lng: flon };
                storage.pins.push(p); addPin(p);
            } else {
                if (tempPath.length < 2) return;
                let d = 0; for(let i=1; i<tempPath.length; i++) d += L.latLng(tempPath[i-1]).distanceTo(L.latLng(tempPath[i]));
                flat = tempPath[0][0]; flon = tempPath[0][1];
                const w = { id, name, desc, rating: rat, path: [...tempPath], dist: (d/1000).toFixed(2), lat: flat, lng: flon };
                storage.walks.push(w); addWalk(w);
            }
            saveData(); document.getElementById('modal-overlay').style.display = 'none'; goBack();
            fetchPhoto(flat, flon, id);
        };

        async function fetchPhoto(lat, lon, id) {
            try {
                const res = await fetch(`https://en.wikipedia.org/w/api.php?action=query&list=geosearch&gsradius=500&gscoord=${lat}|${lon}&format=json&origin=*`).then(r=>r.json());
                if(res.query?.geosearch?.length) {
                    const title = res.query.geosearch[0].title;
                    const imgRes = await fetch(`https://en.wikipedia.org/w/api.php?action=query&prop=pageimages&format=json&piprop=original&titles=${encodeURIComponent(title)}&pithumbsize=500&origin=*`).then(r=>r.json());
                    const pg = Object.values(imgRes.query.pages)[0];
                    if(pg.original) {
                        let entry = storage.pins.find(x=>x.id===id) || storage.walks.find(x=>x.id===id);
                        if(entry && !entry.photo) { entry.photo = pg.original.source; saveData(); updateHighlights(); }
                    }
                }
            } catch(e){}
        }

        document.getElementById('photoInput').onchange = function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(event) {
                const item = storage.pins.find(p=>p.id===activeSelectionId) || storage.walks.find(w=>w.id===activeSelectionId);
                if (item) {
                    item.photo = event.target.result;
                    saveData(); document.getElementById('detPhoto').src = item.photo;
                    document.getElementById('detPhoto').style.display = 'block';
                    updateHighlights();
                }
            };
            reader.readAsDataURL(file);
        };

        function addPin(p) { L.marker([p.lat, p.lng]).addTo(mapItems).on('click', (e) => { L.DomEvent.stopPropagation(e); showDetails(p, false, e.target); }); }
        function addWalk(w) { L.polyline(w.path, {color:'#2563eb', weight:5}).addTo(mapItems).on('click', (e) => { L.DomEvent.stopPropagation(e); showDetails(w, true, e.target); }); }

        function showDetails(item, isWalk, layer) {
            if (!item) return;
            activeSelectionId = item.id; isEditing = false;
            document.getElementById('explore-panel').style.display = 'none';
            document.getElementById('add-panel').style.display = 'none';
            document.getElementById('mainTabs').style.display = 'none';
            document.getElementById('backBtn').style.display = 'block';
            const dv = document.getElementById('detail-view'); dv.style.display = 'flex';
            const toggleBtn = document.getElementById('toggleEditBtn');
            toggleBtn.innerText = '‚úèÔ∏è EDIT ENTRY'; toggleBtn.classList.remove('active-saving');
            document.getElementById('deleteItemBtn').style.display = 'none';
            document.getElementById('uploadContainer').style.display = 'none';
            const img = document.getElementById('detPhoto'); img.src = item.photo || ""; img.style.display = item.photo ? 'block' : 'none';
            document.getElementById('editTitle').value = item.name; document.getElementById('editDesc').value = item.desc || "";
            document.querySelectorAll('.edit-input').forEach(i=>i.classList.remove('active'));
            renderStars(item);
            if (isWalk) { updateStatsDisplay(item); fetchElevation(item.path); window.currentActiveLayer = layer; } 
            else { document.getElementById('detStats').innerText = `üìç Saved Pin`; closeElevation(); window.currentActiveLayer = null; }
            nodeHandles.forEach(h=>map.removeLayer(h));
        }

        function updateStatsDisplay(item) {
            if (!item.elevData) { document.getElementById('detStats').innerText = `üìè ${item.dist} km Walk`; return; }
            const max = Math.max(...item.elevData);
            let ascent = 0; for(let i=1; i<item.elevData.length; i++) { let diff = item.elevData[i] - item.elevData[i-1]; if(diff > 0) ascent += diff; }
            document.getElementById('detStats').innerHTML = `üìè ${item.dist} km Walk | ‚õ∞Ô∏è Ascent: ${Math.round(ascent)}m | Max: ${Math.round(max)}m`;
        }

        function renderStars(item) {
            const rDiv = document.getElementById('detRating'); rDiv.innerHTML = "";
            for(let i=1; i<=5; i++) {
                const s = document.createElement('span'); s.innerText = i <= item.rating ? '‚òÖ' : '‚òÜ';
                s.onclick = () => { if(isEditing) { item.rating = i; renderStars(item); saveData(); } };
                rDiv.appendChild(s);
            }
        }

        document.getElementById('toggleEditBtn').onclick = function() {
            isEditing = !isEditing;
            this.innerText = isEditing ? '‚úîÔ∏è SAVE CHANGES' : '‚úèÔ∏è EDIT ENTRY';
            this.classList.toggle('active-saving', isEditing);
            document.getElementById('deleteItemBtn').style.display = isEditing ? 'block' : 'none';
            document.getElementById('uploadContainer').style.display = isEditing ? 'block' : 'none';
            document.querySelectorAll('.edit-input').forEach(inp => inp.classList.toggle('active', isEditing));
            const item = storage.pins.find(p=>p.id===activeSelectionId) || storage.walks.find(w=>w.id===activeSelectionId);
            if(isEditing && storage.walks.some(w=>w.id===activeSelectionId) && window.currentActiveLayer) createNodes(window.currentActiveLayer);
            else nodeHandles.forEach(h=>map.removeLayer(h));
            document.getElementById('editTitle').oninput = () => { item.name = document.getElementById('editTitle').value; saveData(); };
            document.getElementById('editDesc').oninput = () => { item.desc = document.getElementById('editDesc').value; saveData(); };
        };

        function createNodes(layer) {
            nodeHandles.forEach(h => map.removeLayer(h)); nodeHandles = [];
            const latlngs = layer.getLatLngs();
            latlngs.forEach((ll, i) => {
                const m = L.marker(ll, { draggable: true, icon: L.divIcon({ className:'node-handle', iconSize:[12,12], iconAnchor:[6,6] }) }).addTo(map);
                m.on('drag', (e) => { const currentLls = layer.getLatLngs(); currentLls[i] = e.target.getLatLng(); layer.setLatLngs(currentLls); updateWalkStats(); });
                m.on('click', (e) => { if (!isEditing) return; L.DomEvent.stopPropagation(e); const lls = layer.getLatLngs(); if (lls.length > 2) { lls.splice(i, 1); layer.setLatLngs(lls); updateWalkStats(); createNodes(layer); } });
                nodeHandles.push(m);
                if (i < latlngs.length - 1) {
                    const mid = L.latLng((ll.lat + latlngs[i+1].lat) / 2, (ll.lng + latlngs[i+1].lng) / 2);
                    const midH = L.marker(mid, { draggable: true, icon: L.divIcon({ className:'mid-handle', iconSize:[8,8], iconAnchor:[4,4] }) }).addTo(map);
                    midH.on('dragstart', (e) => { const currentLls = layer.getLatLngs(); currentLls.splice(i + 1, 0, e.target.getLatLng()); layer.setLatLngs(currentLls); });
                    midH.on('drag', (e) => { const currentLls = layer.getLatLngs(); currentLls[i + 1] = e.target.getLatLng(); layer.setLatLngs(currentLls); updateWalkStats(); });
                    midH.on('dragend', () => createNodes(layer));
                    nodeHandles.push(midH);
                }
            });
        }

        function updateWalkStats() {
            const layer = window.currentActiveLayer; if (!layer) return;
            const lls = layer.getLatLngs(); let d = 0; for(let j=1; j<lls.length; j++) d += lls[j-1].distanceTo(lls[j]);
            const item = storage.walks.find(w => w.id === activeSelectionId);
            item.dist = (d/1000).toFixed(2); item.path = lls.map(l => [l.lat, l.lng]);
            saveData(); fetchElevation(item.path);
        }

        async function fetchElevation(path) {
            try {
                let sampledPoints = [];
                for (let i = 0; i < path.length - 1; i++) {
                    const start = L.latLng(path[i]);
                    const end = L.latLng(path[i+1]);
                    const dist = start.distanceTo(end);
                    sampledPoints.push(start);
                    const numSteps = Math.floor(dist / 100); 
                    for (let j = 1; j <= numSteps; j++) {
                        const ratio = (j * 100) / dist;
                        sampledPoints.push(L.latLng(start.lat + (end.lat - start.lat) * ratio, start.lng + (end.lng - start.lng) * ratio));
                    }
                }
                sampledPoints.push(L.latLng(path[path.length - 1]));
                const res = await fetch('https://api.open-elevation.com/api/v1/lookup', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ locations: sampledPoints.map(p => ({ latitude: p.lat, longitude: p.lng })) }) }).then(r=>r.json());
                const elevs = res.results.map(r => r.elevation);
                const item = storage.walks.find(w => w.id === activeSelectionId);
                if(item) { item.elevData = elevs; saveData(); updateStatsDisplay(item); }
                let currentTotal = 0, distData = [0];
                for(let i = 1; i < sampledPoints.length; i++){ currentTotal += sampledPoints[i-1].distanceTo(sampledPoints[i]); distData.push(currentTotal / 1000); }
                let labels = distData.map(d => (Math.round(d * 10) / 10).toFixed(1));
                document.getElementById('elevation-dock').classList.add('active');
                const ctx = document.getElementById('elevChart').getContext('2d');
                if(chartInstance) chartInstance.destroy();
                chartInstance = new Chart(ctx, { 
                    type:'line', data:{ labels: labels, datasets:[{ data:elevs, borderColor:'#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.15)', fill:true, pointRadius:0, borderWidth: 2, tension:0.4, cubicInterpolationMode: 'monotone' }] }, 
                    options:{ maintainAspectRatio:false, interaction: { intersect: false, mode: 'index' }, plugins:{ legend:{display:false} },
                    scales:{ x:{ title: { display: true, text: 'Distance (km)', font: { size: 10, weight: 'bold' } }, ticks: { maxTicksLimit: 12, font: { size: 9 }, callback: (v, i) => labels[i] + 'km' } },
                    y:{ title: { display: true, text: 'Height (m)', font: { size: 10, weight: 'bold' } }, ticks: { font: { size: 9 }, callback: (v) => v + 'm' } } } } 
                });
            } catch(e) {}
        }

        function closeElevation() { document.getElementById('elevation-dock').classList.remove('active'); }
        function saveData() { localStorage.setItem('geojournal_v11', JSON.stringify(storage)); }
        document.getElementById('themeToggle').onchange = (e) => { storage.theme = e.target.checked ? 'dark' : 'light'; document.body.className = storage.theme + '-theme'; saveData(); };
        document.getElementById('mapToggle').onchange = (e) => { storage.mapStyle = e.target.checked ? 'sat' : 'voyager'; map.removeLayer(baseLayer); baseLayer = L.tileLayer(mapStyles[storage.mapStyle]).addTo(map); saveData(); };
        document.getElementById('mainSearch').onkeypress = (e) => { if(e.key==='Enter') fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${e.target.value}`).then(r=>r.json()).then(d=>d.length && map.flyTo([d[0].lat, d[0].lon], 15)); };
        document.getElementById('modalStars').onclick = (e) => { if(e.target.dataset.value) { currentRating = parseInt(e.target.dataset.value); document.querySelectorAll('#modalStars .star').forEach(s => s.style.color = s.dataset.value <= currentRating ? '#fbbf24' : '#cbd5e1'); } };
        document.getElementById('deleteItemBtn').onclick = () => { if(confirm("Delete?")){ storage.pins = storage.pins.filter(p => p.id !== activeSelectionId); storage.walks = storage.walks.filter(w => w.id !== activeSelectionId); saveData(); mapItems.clearLayers(); storage.pins.forEach(addPin); storage.walks.forEach(addWalk); goBack(); } };
        document.getElementById('finishWalkBtn').onclick = () => { if(tempPath.length < 2) return; document.getElementById('modalStars').querySelectorAll('.star').forEach(s=>s.style.color='#cbd5e1'); document.getElementById('modal-overlay').style.display = 'flex'; };

        storage.pins.forEach(addPin); storage.walks.forEach(addWalk);
        switchTab('explore');
    </script>
</body>
</html>